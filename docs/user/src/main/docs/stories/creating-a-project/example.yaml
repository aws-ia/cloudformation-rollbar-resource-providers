---
AWSTemplateFormatVersion: '2010-09-09'

Description: |
  The following CloudFormation Rollbar resource types allow the creation and configuration of 
  Rollbar teams, accesses, projects and notification rules and related to your application.
  This allows kicking off monitoring of new projects simply, efficiently, and consistently.

Parameters:
  DayTeamName:
    Type: String
    Description: Display name of the day team
  NightTeamName:
    Type: String
    Description: Display name of the night team
  ReportingTeamName:
    Type: String
    Description: Display name of the reporting team
  PagerDutyApiToken:
    Type: String
    Description: API Token to connect to PagerDuty. Ideally this should be generated by a CloudFormation resource but the provider doesn't support this yet.

Resources:
  RollbarProductionApp:
    Type: Rollbar::Projects::Project
    Properties:
      Name: ProductionApplicationCFN
      Email:
        Enabled: true
        IncludeRequestParams: true
      PagerDuty:
        Enabled: true
        ServiceKey: !Ref PagerDutyApiToken

  RollbarProductionAppAccessToken:
    Type: Rollbar::Projects::AccessToken
    Properties:
      ProjectId: !GetAtt RollbarProductionApp.Id
      Name: Access token
      Scopes:
        - write
        - read
      RateLimitWindowSize: 60
      RateLimitWindowCount: 10

  DayTeam:
    Type: Rollbar::Teams::Team
    Properties:
      Name: !Ref DayTeamName
      AccessLevel: standard
  NightTeam:
    Type: Rollbar::Teams::Team
    Properties:
      Name: !Ref NightTeamName
      AccessLevel: standard
  ReportingTeam:
    Type: Rollbar::Teams::Team
    Properties:
      Name: !Ref ReportingTeamName
      AccessLevel: view

  RollbarProductionAppDayTeamMembership:
    Type: Rollbar::Teams::Membership
    Properties:
      TeamId: !GetAtt DayTeam.Id
      MemberId: !GetAtt RollbarProductionApp.Id
      MemberType: project
  RollbarProductionAppNightTeamMembership:
    Type: Rollbar::Teams::Membership
    Properties:
      TeamId: !GetAtt NightTeam.Id
      MemberId: !GetAtt RollbarProductionApp.Id
      MemberType: project
  RollbarProductionAppReportingTeamMembership:
    Type: Rollbar::Teams::Membership
    Properties:
      TeamId: !GetAtt ReportingTeam.Id
      MemberId: !GetAtt RollbarProductionApp.Id
      MemberType: project

  PagerDutyNewItemRule:
    Type: Rollbar::Notifications::Rule
    Properties:
      ProjectAccessToken: !Ref RollbarProductionAppAccessToken
      PagerDuty:
        Trigger: new_item
        Filters:
          - Type: level
            Operation: gte
            Value: error
  PagerDutyNewReopenedItemRule:
    Type: Rollbar::Notifications::Rule
    Properties:
      ProjectAccessToken: !Ref RollbarProductionAppAccessToken
      PagerDuty:
        Trigger: reactivated_item
        Filters:
          - Type: level
            Operation: gte
            Value: error
  EmailNewReopenedItemRule:
    Type: Rollbar::Notifications::Rule
    Properties:
      ProjectAccessToken: !Ref RollbarProductionAppAccessToken
      Email:
        Trigger: exp_repeat_item
        Filters:
          - Type: level
            Operation: gte
            Value: error
        Config:
          Teams:
            - !Ref DayTeamName
            - !Ref NightTeamName

Outputs:
  IntegrationToken:
    Value: !Ref RollbarProductionAppAccessToken
    Export:
      Name: !Sub "${AWS::StackName}-RollbarProductionAppAccessToken"